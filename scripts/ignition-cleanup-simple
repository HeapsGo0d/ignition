#!/bin/bash
# Simple CLI wrapper for IEC cleanup
set -euo pipefail
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

MODE="basic"
DRY_RUN=0
TIMEOUT=30

while [[ $# -gt 0 ]]; do
    case $1 in
        basic|enhanced|nuclear|forensic) MODE="$1" ;;
        dry-run) MODE="enhanced"; DRY_RUN=1 ;;
        --timeout=*) TIMEOUT="${1#--timeout=}" ;;
        --help|-h)
            echo -e "${GREEN}Ignition Cleanup (IEC Simple) - Privacy-aware container cleanup${NC}"
            echo "Usage: ignition-cleanup [basic|enhanced|nuclear|forensic|dry-run] [--timeout=N]"
            echo ""
            echo "Cleanup Modes (increasing scope and privacy protection):"
            echo "  basic    - Outputs, uploads, temp, bash history, recent logs (<0.015s)"
            echo "  enhanced - Basic + caches, browser data, session artifacts (<0.025s)"
            echo "  nuclear  - Enhanced + models*, state, deep session cleanup (<0.050s)"
            echo "  forensic - Nuclear + secure deletion, metadata scrubbing (<0.100s)"
            echo "  dry-run  - Preview enhanced mode without changes"
            echo ""
            echo "Privacy-Sensitive Targets:"
            echo "  • Shell history, logs, browser data, session configs"
            echo "  • Cache directories, temp files, authentication artifacts"
            echo "  • Process state, metadata, journal entries (forensic mode)"
            echo ""
            echo "Environment Variables:"
            echo "  IEC_DELETE_MODELS=1  - Allow model deletion in nuclear/forensic modes"
            echo "  IEC_DRY_RUN=1        - Enable dry-run mode globally"
            exit 0
            ;;
        *) echo -e "${RED}Unknown option: $1${NC}"; exit 1 ;;
    esac
    shift
done

# Destructive mode safety prompts
if [[ ("$MODE" == "nuclear" || "$MODE" == "forensic") && "${IEC_DRY_RUN:-0}" == "0" ]]; then
    if [[ "$MODE" == "forensic" ]]; then
        echo -e "${RED}🔬 FORENSIC CLEANUP: Maximum privacy protection with secure deletion!${NC}"
        echo -e "${RED}This includes: ALL privacy data + secure deletion + metadata scrubbing${NC}"
    else
        echo -e "${YELLOW}☢️  NUCLEAR CLEANUP: Comprehensive privacy-aware cleanup!${NC}"
        echo -e "${YELLOW}This includes: outputs, uploads, temp, caches, session data, and state${NC}"
    fi

    if [[ "${IEC_DELETE_MODELS:-0}" == "1" ]]; then
        echo -e "${RED}⚠️  IEC_DELETE_MODELS=1: Models will also be deleted!${NC}"
    fi

    read -p "Continue? (y/N): " -n 1 -r
    echo
    [[ ! $REPLY =~ ^[Yy]$ ]] && exit 0
fi

export IEC_DRY_RUN="$DRY_RUN"
export IEC_TIMEOUT_SEC="$TIMEOUT"
exec "$SCRIPT_DIR/iec-simple.sh" "$MODE"