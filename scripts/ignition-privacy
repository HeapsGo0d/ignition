#!/bin/bash
# Ignition Privacy Control Commands
# Terminal interface for privacy blocking system

set -euo pipefail

# Configuration - handle both direct calls and symlinks
if [[ -L "${BASH_SOURCE[0]}" ]]; then
    # Called via symlink, resolve to actual script location
    SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
else
    # Called directly
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
fi

# Status indicators
SUCCESS='âœ…'
ERROR='âŒ'
WARNING='âš ï¸'
INFO='ðŸ”'
PRIVACY='ðŸ›¡ï¸'
DOWNLOAD='ðŸ“¥'
BLOCK='ðŸš«'
MONITOR='ðŸ“Š'

log() {
    local level=$1
    shift
    local message="$@"
    local timestamp=$(date '+%H:%M:%S')
    echo "[$timestamp] $message"
}

# Show current privacy system status
show_status() {
    echo "=== Ignition Privacy Status ==="
    echo ""

    # Check if privacy is enabled
    if [[ "${PRIVACY_ENABLED:-true}" != "true" ]]; then
        echo "$WARNING Privacy protection is DISABLED"
        return
    fi

    # Get privacy state manager status
    if command -v python3 >/dev/null 2>&1; then
        echo "$INFO Privacy State:"
        python3 "$SCRIPT_DIR/privacy_state_manager.py" status 2>/dev/null | jq -r '
            "  Mode: " + .mode,
            "  State: " + .state,
            "  ComfyUI Ready: " + (.comfyui_ready | tostring),
            "  Monitoring Only: " + (.monitoring_only | tostring),
            "  Uptime: " + (.uptime | tostring | split(".")[0]) + "s"
        ' 2>/dev/null || echo "  Status unavailable"
        echo ""
    fi

    # Get download protection status
    echo "$DOWNLOAD Download Protection:"
    if [[ -x "$SCRIPT_DIR/download_protector.sh" ]]; then
        "$SCRIPT_DIR/download_protector.sh" status | sed 's/^/  /'
    else
        echo "  Download protector not available"
    fi
    echo ""

    # Get connection monitoring status
    echo "$MONITOR Connection Monitoring:"
    if [[ -x "$SCRIPT_DIR/connection_monitor.sh" ]]; then
        "$SCRIPT_DIR/connection_monitor.sh" status | sed 's/^/  /'
        echo "  Recent connections:"
        "$SCRIPT_DIR/connection_monitor.sh" recent 5 2>/dev/null | sed 's/^/    /' || echo "    No recent connections logged"
    else
        echo "  Connection monitor not available"
    fi
}

# Show real-time connection monitoring
monitor_connections() {
    echo "$MONITOR Starting real-time connection monitoring..."
    echo "Press Ctrl+C to exit"
    echo ""

    if [[ -x "$SCRIPT_DIR/connection_monitor.sh" ]]; then
        "$SCRIPT_DIR/connection_monitor.sh" realtime 2>/dev/null || {
            echo "$ERROR Connection monitor failed to start realtime monitoring"
            exit 1
        }
    else
        echo "$ERROR Connection monitor not available"
        exit 1
    fi
}

# Show connection summary
show_summary() {
    echo "=== Connection Summary ==="
    echo ""

    if [[ -x "$SCRIPT_DIR/connection_monitor.sh" ]]; then
        "$SCRIPT_DIR/connection_monitor.sh" summary 2>/dev/null || echo "No connection data available"
    else
        echo "$ERROR Connection monitor not available"
    fi
}

# Block all connections immediately (emergency mode)
emergency_block() {
    echo "$BLOCK Activating emergency block mode..."

    if command -v python3 >/dev/null 2>&1; then
        python3 "$SCRIPT_DIR/privacy_state_manager.py" emergency-block
        echo "$SUCCESS Emergency block activated"
    else
        echo "$ERROR Privacy state manager not available"
        exit 1
    fi
}

# Temporarily allow a domain
allow_domain() {
    local domain="$1"
    local duration="${2:-300}"

    echo "$INFO Temporarily allowing $domain for ${duration}s..."

    if command -v python3 >/dev/null 2>&1; then
        python3 "$SCRIPT_DIR/privacy_state_manager.py" allow "$domain" "$duration"
        echo "$SUCCESS Domain temporarily allowed"
    else
        echo "$ERROR Privacy state manager not available"
        exit 1
    fi
}

# Show download status
download_status() {
    echo "=== Download Status ==="
    echo ""

    if [[ -x "$SCRIPT_DIR/download_protector.sh" ]]; then
        "$SCRIPT_DIR/download_protector.sh" status 2>/dev/null || echo "Download protector status unavailable"
    else
        echo "$ERROR Download protector not available"
    fi
}

# Test domain classification
test_domains() {
    echo "=== Domain Classification Test ==="
    echo ""

    if [[ -x "$SCRIPT_DIR/connection_monitor.sh" ]]; then
        "$SCRIPT_DIR/connection_monitor.sh" test
    else
        echo "$ERROR Connection monitor not available"
    fi
}

# Show current activities
show_activities() {
    echo "=== Active Detected Activities ==="
    echo ""

    if command -v python3 >/dev/null 2>&1; then
        python3 "$SCRIPT_DIR/privacy_state_manager.py" status 2>/dev/null | jq -r '
            if .activities.detection_available then
                if .activities.active_count > 0 then
                    "ðŸ” Active Activities: " + (.activities.active_count | tostring),
                    "ðŸŽ¯ High Confidence: " + (.activities.high_confidence_count | tostring),
                    "ðŸ¥ System Health: " + (.activities.health_score | tostring),
                    "",
                    "ðŸ“‹ Activity Details:"
                else
                    "âœ… No active activities detected"
                end
            else
                "âŒ Activity detection not available"
            end
        ' 2>/dev/null || echo "Status unavailable"

        # Show individual activities
        python3 "$SCRIPT_DIR/privacy_state_manager.py" status 2>/dev/null | jq -r '
            if .activities.detection_available and .activities.active_count > 0 then
                .activities.active_activities[] |
                "  â€¢ " + .activity_type + " (PID: " + (.process_info.pid | tostring) +
                ", Confidence: " + (.confidence | tostring) +
                ", Policy: " + .policy_action + ")" +
                if (.allowed_domains | length) > 0 then
                    "\n    Domains: " + (.allowed_domains | join(", "))
                else
                    ""
                end
            else
                empty
            end
        ' 2>/dev/null
    else
        echo "$ERROR Python3 not available"
    fi
}

# Debug commands
debug_command() {
    local debug_type="$1"

    case "$debug_type" in
        "activities")
            echo "=== Activity Detection Debug ==="
            echo ""
            show_activities
            ;;
        "health")
            echo "=== System Health Debug ==="
            echo ""
            if command -v python3 >/dev/null 2>&1; then
                python3 "$SCRIPT_DIR/privacy_state_manager.py" status 2>/dev/null | jq -r '
                    if .activities.detection_available then
                        "ðŸ¥ Health Score: " + (.activities.health_score | tostring),
                        "ðŸ”„ Fallback Recommended: " + (.activities.fallback_recommended // false | tostring),
                        "ðŸ“Š Detection Available: " + (.activities.detection_available | tostring)
                    else
                        "âŒ Activity detection not available"
                    end
                ' 2>/dev/null || echo "Status unavailable"
            fi
            ;;
        "timeline")
            echo "=== Activity Timeline Debug ==="
            echo ""
            echo "ðŸ“‹ Recent Connection Log with Activity Context:"
            if [[ -x "$SCRIPT_DIR/connection_monitor.sh" ]]; then
                "$SCRIPT_DIR/connection_monitor.sh" recent 10 2>/dev/null || echo "Connection monitor not available"
            fi
            ;;
        "processes")
            echo "=== Process Monitoring Debug ==="
            echo ""
            echo "ðŸ“Š Interesting Processes:"
            ps aux | grep -E "(pip|git|python|aria2c|wget|curl)" | grep -v grep | head -10
            ;;
        "rules")
            echo "=== Active Rules Debug ==="
            echo ""
            if command -v python3 >/dev/null 2>&1; then
                python3 "$SCRIPT_DIR/privacy_state_manager.py" status 2>/dev/null | jq -r '
                    "ðŸ”’ Current State: " + .state,
                    "ðŸŒ Allowed Domains: " + (.allowed_domains | length | tostring) + " domains",
                    "  " + (.allowed_domains | join(", "))
                ' 2>/dev/null || echo "Status unavailable"
            fi
            ;;
        *)
            echo "Available debug commands:"
            echo "  activities  - Show active detected activities"
            echo "  health      - Show activity detection health status"
            echo "  timeline    - Show recent connections with activity context"
            echo "  processes   - Show interesting running processes"
            echo "  rules       - Show active privacy rules and allowed domains"
            ;;
    esac
}

# Show help
show_help() {
    echo "Ignition Privacy Control Commands"
    echo ""
    echo "Usage: ignition-privacy <command> [args]"
    echo ""
    echo "Commands:"
    echo "  status              Show current privacy system status"
    echo "  monitor             Show real-time connection monitoring"
    echo "  summary             Show connection summary and statistics"
    echo "  downloads           Show active download status"
    echo "  activities          Show detected activities (NEW)"
    echo "  debug <type>        Debug specific component (NEW)"
    echo "  block-all           Emergency block all connections"
    echo "  allow <domain> [s]  Temporarily allow domain (default: 300s)"
    echo "  test                Test domain classification"
    echo "  help                Show this help message"
    echo ""
    echo "Debug Types:"
    echo "  activities          Show active detected activities"
    echo "  health              Show activity detection health"
    echo "  timeline            Show connection timeline with activities"
    echo "  processes           Show interesting processes"
    echo "  rules               Show active privacy rules"
    echo ""
    echo "Aliases:"
    echo "  ignition-status     = ignition-privacy status"
    echo "  ignition-monitor    = ignition-privacy monitor"
    echo "  ignition-block-all  = ignition-privacy block-all"
    echo ""
    echo "Examples:"
    echo "  ignition-privacy status"
    echo "  ignition-privacy activities"
    echo "  ignition-privacy debug health"
    echo "  ignition-privacy debug timeline"
    echo "  ignition-privacy monitor"
    echo "  ignition-privacy allow github.com 600"
    echo "  ignition-privacy block-all"
}

# Main command dispatcher
main() {
    local command="${1:-status}"

    case "$command" in
        "status")
            show_status
            ;;
        "monitor"|"realtime"|"live")
            monitor_connections
            ;;
        "summary"|"stats")
            show_summary
            ;;
        "downloads"|"download-status")
            download_status
            ;;
        "block-all"|"emergency"|"emergency-block")
            emergency_block
            ;;
        "allow"|"whitelist")
            if [[ $# -lt 2 ]]; then
                echo "$ERROR Usage: ignition-privacy allow <domain> [duration]"
                exit 1
            fi
            allow_domain "$2" "${3:-300}"
            ;;
        "test"|"test-domains")
            test_domains
            ;;
        "debug")
            debug_command "${2:-activities}"
            ;;
    "activities")
            show_activities
            ;;
    "help"|"--help"|"-h")
            show_help
            ;;
        *)
            echo "$ERROR Unknown command: $command"
            echo ""
            show_help
            exit 1
            ;;
    esac
}

main "$@"